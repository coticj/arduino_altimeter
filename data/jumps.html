<html>
<head>
    <title>Logger</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">
    <style type="text/css">
        <!--
        body {
            font-family: Arial, Helvetica, sans-serif;
            font-size: small;
            margin: 0;
            padding: 0;
        }

        #head {
            left: 0;
            right: 0;
            padding: 10px;
            background-color: #fdf8ea;
        }

            #head > div + div {
                margin-top: 5px;
            }

        table, th, td {
            border: 1px solid #9fb3e6;
        }

        th, td {
            padding: 1px 5px;
        }

        table {
            margin: 10px;
            font-size: small;
            border-collapse: collapse;
        }

        th {
            background-color: #e1e8fa;
        }

        tr.selected td {
            color: #fff;
            background-color: #36c;
        }

            tr.selected td.plot::after {
                display: inline;
                content: "Yes";
            }

        tbody tr:hover {
            cursor: pointer;
        }

        .text-right {
            text-align: right;
        }

        button {
            background-color: rgba(51, 102, 204, 0.2);
            border: 1px solid #3366cc;
            border-radius: 3px;
            cursor: pointer;
        }

            button.primary {
                background-color: #3366cc;
                color: #fff;
            }
        -->
    </style>

    <script src="jquery-3.2.1.min.js"></script>
    <script type="text/javascript">

        var logfile;
        var tableBody;
        var lastId;

        $(document).ready(function () {
            $.getScript("Chart.min.js")
                .done(function (script, textStatus) {
                    $.ajax({
                        url: "log.txt",
                        dataType: "text",
                        success: function (data) {
                            logfile = data;
                            tableBody = document.getElementById("tableBody");
                            fillTable();
                        }
                    });
                });

        });

        function fillTable() {

            while (tableBody.firstChild)
                tableBody.removeChild(tableBody.firstChild);

            var jumps = logfile.split("||");

            fillTableAjax(jumps, jumps.length - 2);
        }

        function fillTableAjax(jumps, i) {
            var jumpNumber = i + 1;

            var jump = jumps[i].trim();
            var jumpData = jump.split("|");
            var id = Number(jumpData[0]);
            var dateTime = new Date(Number(jumpData[1]) * 1000);
            var location = jumpData[2];
            var aircraft = jumpData[3];

            var tr = document.createElement("tr");
            tr.id = "tr_" + id;
            tr.onclick = function () {
                toggleSelected(this.id);
            };
            tableBody.appendChild(tr);

            if (!lastId)
                lastId = id;

            $.ajax({
                url: "logData_" + id + ".txt",
                dataType: "text",
                success: function (data) {

                    var readings = data.split(";");

                    var time_arr = new Array(readings.length);
                    var altitide_arr = new Array(readings.length);
                    var speed_arr = new Array(readings.length);

                    for (var j = 0; j < readings.length; j++) {
                        var reading = readings[j].split(",");
                        var time = Number(reading[0]) / 100;
                        var altitude = Number(reading[1]) / 100;

                        time_arr[j] = time;
                        altitide_arr[j] = altitude;
                    }

                    var details = getJumpDetails(time_arr, altitide_arr);

                    tr.innerHTML =
                        "<td class=\"text-right\">" + jumpNumber.toString() + "</td>" +
                        "<td>" + dateTime.toString() + "</td>" +
                        "<td>" + location + "</td>" +
                        "<td>" + aircraft + "</td>" +
                        "<td class=\"text-right\">" + Math.round(details.exitAltitude) + " m" + "</td>" +
                        "<td class=\"text-right\">" + Math.round(details.openingAltitude) + " m" + "</td>" +
                        "<td class=\"text-right\">" + Math.round(details.openingTime - details.exitTime) + " s" + "</td>" +
                        "<td class=\"text-right\">" + Math.round(details.maxSpeed) + " km/h" + "</td>" +
                        "<td class=\"text-right\">" + Math.round(details.averageSpeed) + " km/h" + "</td>" +
                        "<td class=\"plot\"></td>"
                        ;

                    --i;
                    if (i >= 0) {
                        fillTableAjax(jumps, i);
                    }
                }
            });
        }

        function getJumpDetails(time_arr, altitide_arr) {
            var offsetConstant = 10;
            var exitSpeedConstant = 50;
            var openingSpeedConstant = 50;

            var speed_arr = new Array(time_arr.length);
            for (var i = 0; i < time_arr.length; i++) {
                var time = time_arr[i];
                var altitude = altitide_arr[i];
                var ofst = (offsetConstant > i) ? i : offsetConstant;
                var timeOffset = time_arr[i - ofst];
                var altitudeOffset = altitide_arr[i - ofst];
                var speed = ((altitudeOffset - altitude) / (time - timeOffset)) * 3.6;

                speed_arr[i] = isNaN(speed) ? 0 : speed;
            }

            var indexOfMaxSpeed = speed_arr.reduce((iMax, x, i, arr) => x > arr[iMax] ? i : iMax, 0);
            var indexOfAfterExit;
            for (var i = indexOfMaxSpeed - 1; i > -1; i--) {
                if (speed_arr[i] < exitSpeedConstant) {
                    indexOfAfterExit = i;
                    break;
                }
            }
            var indexOfExit = indexOfAfterExit;
            var speedAfterExit = speed_arr[indexOfAfterExit];
            for (var i = indexOfAfterExit - 1; i > -1; i--) {
                if (speed_arr[i] < speedAfterExit) {
                    indexOfExit = i;
                    speedAfterExit = speed_arr[i];
                }
                else {
                    break;
                }
            }
            var indexOfOpening;
            for (var i = indexOfMaxSpeed + 1; i < speed_arr.length; i++) {
                if (speed_arr[i] < openingSpeedConstant) {
                    indexOfOpening = i - (offsetConstant - 1);
                    break;
                }
            }

            var avgSpeed = ((altitide_arr[indexOfExit] - altitide_arr[indexOfOpening]) / (time_arr[indexOfOpening] - time_arr[indexOfExit])) * 3.6;

            var details = new Object();
            details.exitAltitude = altitide_arr[indexOfExit];
            details.exitTime = time_arr[indexOfExit];
            details.openingAltitude = altitide_arr[indexOfOpening];
            details.openingTime = time_arr[indexOfOpening];
            details.maxSpeed = speed_arr[indexOfMaxSpeed].toFixed(2);
            details.maxSpeedTime = time_arr[indexOfMaxSpeed];
            details.averageSpeed = avgSpeed.toFixed(2);
            details.indexOfExit = indexOfExit;
            details.indexOfOpening = indexOfOpening;
            return details;
        }

        function plotLast() {
            window.location.href = "plot.html?i=" + lastId;
        }

        function plotSelected() {
            var ids = "";
            for (var i = 0, tr; tr = tableBody.rows[i]; i++) {
                if (tr.classList.contains("selected"))
                    ids += tr.id.replace("tr_", "") + "|";
            }

            if (ids.length) {
                ids = ids.slice(0, -1);
                window.location.href = "plot.html?i=" + ids;
            }
            else {
                alert("No jumps selected.");
            }
        }

        function toggleSelected(id) {
            var tr = document.getElementById(id);
            tr.classList.toggle("selected");
        }

        Date.prototype.toString = function () {
            return (
                this.getUTCFullYear() + "-" + (this.getUTCMonth() + 1) + "-" + this.getUTCDate() +
                " " +
                this.getUTCHours() + ":" + this.getUTCMinutes()
            );
        }

        function goTo(t) {
            window.location.href = t;
        }
    </script>
</head>
<body>
    <div id="head">
        <div>
            <button type="button" onclick="goTo('index.html')">
                Start page
            </button>
        </div>
        <div>
            <button type="button" class="primary" onclick="plotLast()">
                Plot last jump
            </button>
            <button type="button" class="primary" onclick="plotSelected()">
                Plot selected jumps
            </button>
        </div>
    </div>
    <table>
        <thead>
            <tr>
                <th>#</th>
                <th>Date and time</th>
                <th>Location</th>
                <th>Aircraft</th>
                <th>Exit<br />altitude</th>
                <th>Opening<br />altitude</th>
                <th>Freefall<br />time</th>
                <th>Max speed<br />(5 sec avg)</th>
                <th>Average<br />speed</th>
                <th>Plot</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>
</body>
</html>
