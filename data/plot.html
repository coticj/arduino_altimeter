
<html><body onload="init()">ï»¿
<head>
    <title>Logger</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="-1">

    <script src="jquery-3.2.1.min.js"></script>
    <script type="text/javascript">
        var logfile;
        var offsetInput;
        var offset;
        var smoothing;
        //lahko naloadamo samo file po file, zaporedno
        $(document).ready(function() {
            $.getScript( "Chart.min.js" )
              .done(function( script, textStatus ) {
                $.ajax({
                    url: "log.txt",
                    dataType: "text",
                    success: function(data) {
                        logfile = data;
                        drawCharts();
                    }
                });        
              });
            
        });

        function init() {
            input = document.getElementById('input');
            smoothing = document.getElementById('smoothing');

            offsetInput = document.getElementById('offset');
            onSmoothingChange();
        }

        function drawCharts() {

            var charts = document.getElementById('charts')

            while (charts.firstChild)
                charts.removeChild(charts.firstChild);


            var jumps = logfile.split(";;");

            for (var i = jumps.length-1; i >= 0; i--) {

                var jumpNumber = i + 1;

                var canvas = document.createElement("canvas");
                canvas.id = "chart" + jumpNumber;
                charts.appendChild(canvas);

                var jump = jumps[i];

                var readings = jump.split(";");
                var readingFirst = readings[0].split(",");
                var timeFirst = Number(readingFirst[0]);

                var time_arr = new Array(readings.length);
                var altitide_arr = new Array(readings.length);
                var speed_arr = new Array(readings.length);

                for (var j = 0; j < readings.length; j++) {
                    var reading = readings[j].split(",");
                    var timeRelative = (Number(reading[0]) - timeFirst) / 1000;
                    var time = Number(reading[0]);
                    var altitude = Number(reading[1]) / 100;
                    var ofst = (offset > j) ? j : offset;
                    var readingOffset = readings[j - ofst].split(",");
                    var timeOffset = Number(readingOffset[0]);
                    var altitudeOffset = Number(readingOffset[1]) / 100;
                    var speed = ((altitudeOffset - altitude) / (time - timeOffset)) * 1000 * 3.6;

                    time_arr[j] = timeRelative
                    altitide_arr[j] = altitude;
                    speed_arr[j] = speed;
                }

                drawChart(canvas, jumpNumber, time_arr, altitide_arr, speed_arr);
            }

        }

        function drawChart(canvas, jumpNumber, time_arr, altitide_arr, speed_arr) {
            var chart = new Chart(canvas, {
                type: 'line',

                data: {
                    labels: time_arr,
                    datasets: [{
                            label: "Altitude",
                            borderColor: '#3366cc',
                            backgroundColor: 'transparent',
                            data: altitide_arr,
                            yAxisID: "y-axis-left",
                            pointHitRadius: 5
                        },
                        {
                            label: "Speed",
                            borderColor: '#dc3912',
                            backgroundColor: 'transparent',
                            data: speed_arr,
                            yAxisID: "y-axis-right",
                            pointHitRadius: 5
                        }
                    ]
                },

                options: {
                    title: {
                        display: true,
                        text: 'jump ' + jumpNumber,
                        fontSize: 18
                    },
                    elements: {
                        point: {
                            radius: 0
                        }
                    },
                    legend: {
                        labels: {
                            boxWidth: 12
                        }
                    },
                    tooltips: {
                        mode: 'index',
                        backgroundColor: 'rgba(255,255,255,0.8)',
                        titleFontColor: '#666',
                        bodyFontColor: '#666',
                        footerFontColor: '#666',
                        borderColor: 'rgba(0,0,0,0.5)',
                        borderWidth: 1,
                        displayColors: false,
                        position: 'nearest'
                    },
                    responsive: true,
                    scales: {
                        xAxes: [{
                            scaleLabel: {
                                display: true,
                                labelString: 'Time (s)'
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0
                            }
                        }],
                        yAxes: [{
                                type: "linear",
                                display: true,
                                position: "left",
                                id: "y-axis-left",
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Altitude (m)'
                                },
                            },
                            {
                                type: "linear",
                                display: true,
                                position: "right",
                                id: "y-axis-right",
                                scaleLabel: {
                                    display: true,
                                    labelString: 'Speed (km/h)'
                                },
                            }
                        ]
                    }
                }
            });
        }

        function onSmoothingChange() {
            offset = Number(offsetInput.value);
            smoothing.innerHTML = offset * 0.5 + " s";
        }

        function convertToJSON() {

            json = document.getElementById('json');

            var isInputJson = input.value.startsWith("[");

            if (isInputJson) {
                json.innerHTML = "No need to convert.";
            } else {
                var s = "[\n";

                var jumps = input.value.split(";;");

                for (var i = 0; i < jumps.length; i++) {

                    s += "{ \"readings\": [ ";

                    var jump = jumps[i];

                    var readings = jump.split(";");

                    for (var j = 0; j < readings.length; j++) {
                        var reading = readings[j].split(",");
                        var time = Number(reading[0]);
                        var altitude = Number(reading[1]) / 100;

                        s += "{\"time\": " + time + ", \"altitude\": " + altitude + "}";
                        if (j < readings.length - 1)
                            s += ", ";
                    }

                    s += " ] }";

                    if (i < jumps.length - 1)
                        s += ",\n";
                }

                s += "\n]";

                json.innerHTML = s;
            }
        }
    </script>

</head>

    <div id="head">
        
        <div style="height: 5px">
        </div>
        <div>
            smoothing:
            <input id="offset" type="text" onchange="onSmoothingChange()" value="10" style="width: 50px" />
            = <span id="smoothing"></span><span style="display: inline-block; width: 20px;">
            </span>
            <button type="button" onclick="drawCharts()">
                Plot charts
            </button>
            
        </div>
    </div>
    <div id="charts">
    </div>
</body>
</html>
